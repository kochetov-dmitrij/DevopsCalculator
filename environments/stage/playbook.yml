---
- hosts: all
  become: true
  vars:
    project_local_path: ~/devops_course/DevopsCalculator
    project_vagrant_path: ~vagrant/DevopsCalculator
    environment_vars:
    - key: JAVA_HOME
      value: /usr/lib/jvm/java-8-openjdk-amd64
  vars_files:
  - vars.yml

  pre_tasks:
  - name: Update apt cache if needed
    apt: update_cache=yes cache_valid_time=3600
  - name: Populate /etc/environment
    lineinfile:
      dest: /etc/environment
      state: present
      regexp: "^{{item.key}}="
      line: "{{item.key}}={{item.value}}"
    with_items: "{{environment_vars}}"

  tasks:
  - name: Copy public key
    copy: src=~/.ssh/id_rsa_devops_course.pub dest=~vagrant/.ssh/me.pub
  - shell: cat ~vagrant/.ssh/me.pub
    register: public_key
  - lineinfile:
      path: ~vagrant/.ssh/authorized_keys
      line: "{{public_key.stdout}}"

  - name: Install Java8
    apt: name=openjdk-8-jdk state=latest
  - name: Update PATH with Java/bin
    lineinfile:
      dest: /etc/environment
      state: present
      backrefs: yes
      regexp: "^PATH=\"((?:(?!\\$JAVA_HOME/bin).)*)\"$"
      line: 'PATH="$JAVA_HOME/bin:\1"'

  - name: Copy app sources
    copy: src={{item.src}} dest={{item.dest}} mode={{item.mode}}
    with_items:
    - { src: "{{project_local_path}}/src", dest: "{{project_vagrant_path}}", mode: '777'}
    - { src: "{{project_local_path}}/pom.xml", dest: "{{project_vagrant_path}}", mode: '777'}
    - { src: "{{project_local_path}}/mvnw", dest: "{{project_vagrant_path}}", mode: '777'}
    - { src: "{{project_local_path}}/.mvn", dest: "{{project_vagrant_path}}", mode: '777'}
